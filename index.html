<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Cache-Control" content="no-cache" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta content="author=Lei Kinsueng;organization=xuans;department=xuans network lab.yips;" />
    <meta content="baseon=望晴2_UI;version=6.7.0.1;" />
    <meta content="create-datetime=2015/2/3 Tue 22:45" />
    <meta content="copyright=祥琳健尚|Xuans 2015" />
    <meta content="code-name=雯晴|minQ;" />
    <meta content="slogon=创造力 创造 创造性;" />
    <meta content="minimal-ui" name="viewport">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
    <meta content="no" name="apple-mobile-web-app-capable" />
    <link rel="Shortcut Icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script>
        function queryString(name) {
            var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]); return null;
        }
        var imagesCounts = 389,
            hsl = queryString('hsl') || document.location.replace('?hsl=' + parseInt(Math.random() * 361, 0) + '&bgi=' + parseInt(Math.random() * imagesCounts + 1, 0));
        //判断屏幕大小
        var pcScreenMinWidth = 800, isPcScreen = false, isNotInputFocus = true;
        if (window.screen.availWidth >= pcScreenMinWidth || window.screen.availHeight >= pcScreenMinWidth) {
            document.write('<link href=\"common\/jquery.mCustomScrollbar.min.css\" rel=\"stylesheet\" \/>');
            isPcScreen = true;
        }
    </script>
    <link href="common/style.css" rel="stylesheet" />
    <title>解忧集 | 祥琳健尚-望晴-望晴2_UI-雯晴|minQ</title>
</head>
<body>
    <div class="bg-div">
        <canvas id="bgCanvas" style="display:none;"></canvas>
    </div>
    <header data-role="header" class="header">
        <ul class="header-titles no-select">
            <li class="title"><a href="/">祥琳健尚</a></li>
            <li class="title"><a href="/yips/yips.asp">望晴</a></li>
            <li class="title"><a href="./">雯晴minQ-解忧集</a></li>
            <li id="mainTitle" class="title main-title">
                <span id="defaultPageTitle">主页</span>
                <span id="addPageTitle" style="display:none">添加来信者</span>
                <span id="dialogPageTitle" style="display:none"></span>
                <span id="asideMenuTitle" style="display:none">目录</span>
            </li>
            <li class="func-btns">
                <button id="BtnAdd" class="title btn-add no-select">+<span class="info-name">&nbsp;添加</span></button>
            </li>
        </ul>
    </header>
    <div id="content" data-role="content">
        <aside class="aside">
            <ol class="aside-menu no-select" id="asideMenu">
                <li class="no-topic-title" data-id="-1">暂无来信者</li>
            </ol>
        </aside>
        <article class="article">
                <!--主页 start-->
                <div id="defaultPage">
                    <div class="default-page-title no-select title">解<br />忧<br />集</div>
                    <p class="default-page-sub-title no-select">祥琳健尚&nbsp;希璇文学库</p>
                    <p class="default-page-sub-title no-select">二〇一四甲午年&nbsp;八月</p>
                </div>
                <!--主页 end-->
                <!--添加来信者 start-->
                <div id="addPage">
                    <form id="addPageForm" method="post" >
                        <h4 class="writer-info-input-title">基本信息</h4>
                        <ol class="writer-info-input-list">
                            <li>
                                <label class="writer-info-input-label">姓名</label>
                                <input type="text" required="required" name="writerName" id="writerName" placeholder="姓名" value="" tabindex="1" class="writer-info-inputer" />
                            </li>
                            <li>
                                <label class="writer-info-input-label">性别</label>
                                <select id="writerIsMan" name="writerIsMan" class="writer-info-inputer" required="required" tabindex="2">
                                    <option disabled="disabled" value="" selected="selected">请选择…</option>
                                    <option value="0">男</option>
                                    <option value="1">女</option>
                                    <option value="2">未知</option>
                                </select>
                            </li>
                            <li>
                                <label class="writer-info-input-label">地区</label>
                                <input type="text" name="writerArea" id="writerArea" placeholder="地区" value="" class="writer-info-inputer" required="required" tabindex="3" />
                            </li>
                        </ol>
                        <hr class="writer-info-input-hr" />
                        <h4 class="writer-info-input-title">主题</h4>
                        <ol class="writer-info-input-list">
                            <li>
                                <label class="writer-info-input-label">主题</label>
                                <input type="text" name="topicTitle" id="topicTitle" placeholder="主题" value="" class="writer-info-inputer" required="required" tabindex="4" />
                            </li>
                        </ol>
                        <div class="writer-info-input-btn-group">
                            <button class="writer-info-input-btn btn" type="button" id="addPageBtn" tabindex="5">添加</button>
                        </div>
                    </form>
                </div>
                <!--添加来信者 end-->
                <!--对话 start-->
                <div id="dialogPage">
                </div>
                <!--对话 end-->
        </article>
    </div>
    <footer data-role="footer">
        <ul class="footer-list no-select" >
            <li>祥琳健尚&copy;</li>
            <li>望晴</li>
            <li>2015</li>
            <li>雯晴minQ</li>
            <li>ナミヤ雑貨店</li>
        </ul>
        <p class="watermark no-select">
            ナミヤ雑貨店
        </p>
    </footer>
    <div id="topicTitleTemp" class="hide">
        <ol>
            <li data-id="writerID">
                <dl class="writer-info">
                    <dt>第listIndex位来信者</dt>
                    <dd title="writerInfo"><span class="info-name">基本信息：</span>writerInfo</dd>
                    <dd title="topicTitle"><span class="info-name">主题：</span>topicTitle</dd>
                </dl>
            </li>
        </ol>
    </div>
    <script src="common/jquery-1.11.2.js"></script>
    <script src="common/stackBlur.min.js"></script>
    <script type='text/javascript'>
        var titleWidths = new Array();
        var contentElems = ['.aside', '.article'],
            scrollbarStyle = {
                axis: "y",
                scrollButtons: { enable: false },
                theme: "rounded",
            },
            pageElems = ['#defaultPage', '#addPage', '#dialogPage'],
            scrollbarElems = [contentElems[0]].concat(pageElems);
        if (window.navigator.msPointerEnabled) {
            scrollbarStyle.theme = 'light-2';
        }
        var backgroundImage, bgImage = new Image(),isNotSupportFilter;
        if (isPcScreen) {
            //预加载图片
            var $bgDiv = $('.bg-div');
            isNotSupportFilter = !($bgDiv.css('-webkit-filter') || $bgDiv.css('-ms-filter') || $bgDiv.css('-moz-filter') || $bgDiv.css('filter') !== 'none');
            if (isNotSupportFilter && !document.getElementById('bgCanvas').style.display) {
                $bgDiv.css('background-image', "url('blur.svg')");
            } else {
                backgroundImage = document.location.pathname + 'images/%20%28' + ($.queryString('bgi') || parseInt(Math.random() * imagesCounts + 1, 0)) + '%29.jpg';
                bgImage.src = backgroundImage;
                bgImage.onload = function () {
                    if (isNotSupportFilter) {
                        //IE11不支持滤镜补丁
                        var bgImgElem = document.createElement('img');
                        bgImgElem.src = backgroundImage;
                        bgImgElem.id = 'bgImg';
                        bgImgElem.style.display = 'none';
                        document.body.appendChild(bgImgElem);
                        setTimeout(function () {
                            stackBlurImage("bgImg", 'bgCanvas', 6, true);
                            var $bgCanvas = $('#bgCanvas'),
                                bgCanvasWidth = $bgCanvas.width(),
                                bgCanvasProportion = (bgCanvasWidth / $bgCanvas.height()).toFixed(2);
                            $bgCanvas.css({
                                'height': '100%',
                                'width': 'auto',
                            }).fadeIn(500);
                            //IE10不支持width=auto start
                            if (bgCanvasProportion !== ($bgCanvas.width() / $bgCanvas.height()).toFixed(2)) {
                             //   alert('not-fixed');
                                $bgCanvas.css({
                                    'width': bgCanvasProportion*$bgCanvas.height()
                                });
                            }
                            $(window).resize(function () {
                                if (isPcScreen && isNotSupportFilter && $(this).width() >= pcScreenMinWidth) {
                                    $bgCanvas.css({
                                        'width': bgCanvasProportion * $bgCanvas.height()
                                    });
                                }
                            });
                            //IE10不支持width=auto end
                        }, 800);
                    }
                    backgroundImage = 'url(\'' + backgroundImage + '\')';
                    $bgDiv.css({
                        'background-image': backgroundImage,
                    }).animate({
                        'opacity': 1
                    });
                };
            }
            //PC屏幕大小下加载滚动条插件
            document.write('<script src=\"common\/jquery.mCustomScrollbar.concat.min.js\"><\/script>');
        }

        //onLoad & Listener
        $(function () {
            var hslp, isMainTitleHidden;
            /*修复inline-block空隙 Start*/
            $('.header-titles').contents().filter(function () {
                return this.nodeType === 3;
            }).remove();
            $('#content').contents().filter(function () {
                return this.nodeType === 3;
            }).remove();
            /*修复inline-block空隙 End*/
            /*设置header背景色 Start*/
            //$('body').hide();
            //hsl = $.queryString('hsl') || document.location.replace('?hsl=' + parseInt(Math.random() * 361, 0) + '&bgi=' + parseInt(Math.random() * imagesCounts + 1, 0));
            //hsl = parseInt(Math.random() * 360, 0);
            hslp = 30;
            $('.header-titles li.title:not(:last)').each(function () {
                $(this).hslTorgba('background-color','hsl(' + hsl + ',50%,' + (hslp += 10) + '%)',hslp*.01);
            });
            $('header').hslTorgba('background-color', 'hsl(' + hsl + ',50%,' + (hslp += 10) + '%)', .5).fadeIn(100);
            $('aside').hslTorgba('background-color', 'hsl(' + hsl + ',50%,' + (hslp += 10) + '%)', .8);
            $('body').animate({
                'opacity':1
            });
            /*设置header背景色 End*/
            /*设置header动画 Start*/
            var isHeaderTitleToggle = false;
            $('.header-titles').click(function (e) {
                if (!isHeaderTitleToggle) {
                    isHeaderTitleToggle = true;
                    var $src = $(e.target || event.srcElement);
                    if (!isMainTitleHidden && $(window).width() >= pcScreenMinWidth) {
                        isMainTitleHidden = true;
                        //console.log($src.parent().html());
                        if ($src.hasClass('header-titles') || $src.parent().hasClass('main-title')) {
                            //title
                            for (var i = 0, elemWidth,
                                elems = $('.header-titles li.title:not(:last)'),
                               $elem; !!($elem = $(elems[i])).length; i++) {
                                elemWidth = $elem.width();
                                $elem.animate({
                                    'width': parseInt(elemWidth) > 0 ? (!titleWidths[i] ? titleWidths[i] = elemWidth : 0) && 0 : titleWidths[i]
                                });
                            }
                            //aside&article
                            var $asideElem = $(contentElems[0]),
                                asideWidth = parseInt($asideElem.css('max-width'), 0) - parseInt($asideElem.css('width'), 0);
                            $asideElem.animate({
                                width: asideWidth,
                            });
                            $(contentElems[1]).animate({
                                'width': $('#content').innerWidth() - asideWidth,
                                'max-width': $('#content').innerWidth() - asideWidth,
                            });
                        }
                        isMainTitleHidden = false;
                    } else if ($(window).width() < pcScreenMinWidth) {
                        //显示或隐藏aside/article
                        if ($src.hasClass('header-titles') || $src.parent().hasClass('main-title')) {
                            for (var elem in contentElems) {
                                $(contentElems[elem]).toggleClass('aside-show');
                            }
                            setMainTitle();
                        }
                    }
                    setTimeout(function () {
                        isHeaderTitleToggle = false;
                    }, 500);
                }
            });
            /*设置header动画 End*/
            /*设置屏幕宽度、高度 Start */
            var windowWidth=0, currentWindowWidth, resizeWidthTimer,resizeHeightTimer;
            $(window).resize(function () {
                if (isPcScreen) {
                    
                    currentWindowWidth = $(this).width();
                    //处理屏幕宽度部分
                    if (currentWindowWidth >= pcScreenMinWidth) {
                        if (Math.abs(currentWindowWidth - windowWidth) > 100 || currentWindowWidth === windowWidth) {
                            clearTimeout(resizeWidthTimer);
                            windowWidth = currentWindowWidth;
                            resizeWidthTimer = setTimeout(resizeHeaderTitle, 200);
                        }
                    }
                    //处理屏幕高度部分
                    clearTimeout(resizeHeightTimer);
                    resizeHeightTimer = setTimeout(resizeContentSize, 200, currentWindowWidth);
                }
            });
            if (isPcScreen) {
                resizeHeaderTitle();
                resizeContentSize($(window).width());
            }
            /*设置屏幕宽度、高度 End */

            //IE下触屏滚动补丁
            if (!!$('body').css('-ms-touch-action') && window.navigator.msPointerEnabled) {
                for (var i = 0, elem; (elem = scrollbarElems[i]) != null; i++) {
                    $(elem)[0].onmspointerenter = function (innerEvent) {
                        if (innerEvent.which === 1 && $(this).hasClass('mCustomScrollbar')) {
                            $(this).mCustomScrollbar('destroy');
                            // console.log('destory');
                        } else if (innerEvent.which === 0 && !$(this).hasClass('mCustomScrollbar')) {
                            $(this).mCustomScrollbar(scrollbarStyle);
                            // console.log('create');
                        }
                    }
                }
            }

            //btn-add click
            $('#BtnAdd').click(function () {
                showPageByIndex(1,true);
            });
            //用于触屏效果下的软键盘导致resize的补丁
            $(':input:not(button)').focus(function () {
                isNotInputFocus = false;
                // alert(isNotInputFocus);
            }).blur(function () {
                isNotInputFocus = true;
                // alert(isNotInputFocus);
            }).keyup(function (e) {
                /*等我看完jQUery再说*/
            });
            $(window).keydown(function (e) {
                console.log(e.which);
            });
            //aside-menu click
            $('.aside-menu').click(function (e) {
                var $writerElem = $($(e.target || window.event.srcElement).closest('li'));
                if (!!$writerElem.length) {
                    showDialogByID($writerElem.attr('data-id'),
                        '第' + ($writerElem.index() + 1) + '位：' + $writerElem.find('dd:last').attr('title'));
                    if(isPcScreen){
                        $(contentElems[0]).mCustomScrollbar('scrollTo',$writerElem);
                    }
                }
            });
        });
        //resize headerTitle size
        function resizeHeaderTitle() {
            titleWidths.splice(0, titleWidths.length);
            $('.header-titles li.title:not(:last)').css('width', 'auto');
        }
        //resize #content size
        function resizeContentSize(windowWidth) {
            if (isNotInputFocus) {
                if (windowWidth >= pcScreenMinWidth) {
                    //#content宽度部分
                    var contentHeight = $(window).innerHeight() - $('header').outerHeight() - $('footer').outerHeight();
                    $('#content').css({
                        'height': contentHeight,
                        'max-height': contentHeight,
                    });

                    var contentWidth = $('#content').innerWidth() - $(contentElems[0]).css('width', 'auto').outerWidth();
                    $(contentElems[1]).animate({
                        'width': contentWidth,
                        'max-width': contentWidth,
                    });
                    //滚动条部分
                    for (var elems in scrollbarElems) {
                        $(scrollbarElems[elems]).mCustomScrollbar(scrollbarStyle);
                        $(scrollbarElems[elems]).mCustomScrollbar("update");
                    }
                    //全屏时mainTitle不显示‘目录’
                    if ($(contentElems[0]).hasClass('aside-show')) {
                        setMainTitle();
                    }
                } else {
                    //恢复
                    $('#content').css({
                        'height': 'auto',
                        'max-height': '100%',
                    });

                    $(contentElems[1]).css({
                        'width': 'auto',
                        'max-width': windowWidth,
                    });
                    for (var i = 0, elem; (elem = scrollbarElems[i]) != null; i++) {
                        $(elem).css({
                            'width': 'auto',
                            'max-width': 'auto',
                        }).mCustomScrollbar("destroy");
                    }
                    if ($(contentElems[0]).hasClass('aside-show')) {
                        setMainTitle('#asideMenuTitle');
                    }
                }
            }
        }
        //设置显示的标题
        function setMainTitle(displayTitleID) {
            //要求显示的存在
            var $mainTitle=$('#mainTitle');
            $('span',$mainTitle).css('display', 'none');
            if (!!displayTitleID) {
                $(displayTitleID, $mainTitle).css('display', '');
            } else if ($(contentElems[0]).hasClass('aside-show')&&$(window).width()<pcScreenMinWidth) {
                $('#asideMenuTitle').css('display', '');
            } else {
                $pagedefault = $(pageElems[0]);
                for (var i = 1, pageName; (pageName = pageElems[i]) != null; i++) {
                    if ($pagedefault.hasClass(pageName.substring(1) + '-show')) {
                        $(pageName + 'Title').css('display', '');
                        return;
                    }
                }
                $(pageElems[0] + 'Title').css('display', '');
            }
        }
        //错误提示
        function showError(msg) {
            console.log(msg);
        }
        //显示对话框
        function showDialogByID(writerID,topicTitle) {
            if (!writerID||writerID<0) {
                showError('0x003无来信者ID');
            } else {
                /*清空dialogPage*/

                /*ajax dialog数据*/
                /*显示dialogPage*/
                //console.log(topicTitle);
                showPageByIndex(2);
                $(pageElems[2] + 'Title').text(topicTitle);
            }
        }
        //显示子页面
        function showPageByIndex(index,isFocusOnFirstObject) {
            //console.log(index);
            if (!index || index < 0 || index >= pageElems.length) {
                showError('0x004显示子页面索引错误');
            } else {
                var i = 0, elem,
                    showClass = pageElems[index].substring(1) + '-show',
                removeClass = (pageElems[pageElems.length - index].substring(1) || '') + '-show';
                //窄屏下隐藏aside
                for (; (elem = contentElems[i]) != null; i++) {
                    $(elem).removeClass('aside-show');
                    //console.log('remove asideShow');
                }
                //显示或隐藏目录
                //console.log(index, showClass, removeClass);
                if (index === 1 && $(pageElems[index]).hasClass(showClass)) {
                    for (i = 0; (elem = pageElems[i]) != null; i++) {
                        $(elem).removeClass(showClass);
                    }
                    setMainTitle();
                    $('.bg-div').removeClass('deeper');
                } else {
                    for (i = 0; (elem = pageElems[i]) != null; i++) {
                        $(elem).removeClass(removeClass).addClass(showClass);
                    }
                    setMainTitle(pageElems[index] + 'Title');
                    $('.bg-div').addClass('deeper');

                    if (!!isFocusOnFirstObject) {
                        setTimeout(function () {
                            $(':input:first', $(pageElems[index])).focus();
                        }, 800);
                    }
                }
                // if (isPcScreen) {
                //     $(contentElems[1]).mCustomScrollbar("update");
                // }
            }
        }
        //添加主题到菜单
        function addWriterInfoMenu(writerInfo,isNotUpdate,isNotScrollToButtom) {
            var topicTitleTemp = $('ol', $('#topicTitleTemp')).html(),
                $asideMenu = $('#asideMenu');
            $asideMenu.children('.no-topic-title').remove()
            switch (writerInfo.writerIsMan) {
                case '0':
                    writerInfo.writerIsMan = '男';
                    break;
                case '1':
                    writerInfo.writerIsMan = '女';
                    break;
                default:
                    writerInfo.writerIsMan = '未知';
            }
            topicTitleTemp = topicTitleTemp
                .replace(/writerID/g, writerInfo.writerID)
                .replace(/writerInfo/g, [writerInfo.writerName, writerInfo.writerIsMan, writerInfo.writerArea].join('，'))
                .replace(/topicTitle/g,writerInfo.topicTitle)
                .replace(/listIndex/g, $asideMenu.children().length + 1);
            $asideMenu.append(topicTitleTemp);
            if (!isNotUpdate && isPcScreen) {
                $(scrollbarElems[0]).mCustomScrollbar("update");
            }
            if (!isNotScrollToButtom && isPcScreen) {
                $(scrollbarElems[0]).mCustomScrollbar('scrollTo', ['bottom', null]);
            }
            //console.log(topicTitleTemp);
        }
    </script>
    <script>
        //ajax部分
        var errorTips='<span class="error">*必须填写</span>'
        $(function () {
            $.ajax({
                cache: false,
                type: 'Get',
                url: 'ajax/getTopicTitle.asp',
                data:'writerID='+($.queryString('writerID')||''),
            }).done(function (data) {
                var writers = eval(data);
                //console.log(data);
                if (writers.length > 1) {
                    for (var i = 0; i < writers.length - 2; i++) {
                        addWriterInfoMenu(writers[i],true,true);
                    }
                    addWriterInfoMenu(writers[i],false,true);
                }
            }).fail(ajaxFail);

            //点击添加按钮
            $('#addPageBtn').click(function () {
                var $addPageBtn = $(this),
                    $addPageForm = $('#addPageForm');
                $addPageBtn.attr('disabled', 'disabled');

                if ($.checkFormRequired($addPageForm,errorTips)) {
                    //必填的部分已经全部填完
                    $.ajax({
                        cache: true,
                        type: 'POST',
                        url: 'ajax/addTopic.asp',
                        data: $addPageForm.serialize().replace(/\+/g, ''),
                    }).done(function (data) {
                        writer = $.parseJSON(data);
                        //显示以writerID为首的对话框
                        if (writer.writerID != -1) {
                            $addPageBtn.removeAttr('disabled');
                            //将整个添加来信者queryString转成json对象添加到asideMenu中
                            addWriterInfoMenu($.queryStringToJson($addPageForm.serialize().replace(/\+/g, '') + '&writerID=' + writer.writerID));
                            showDialogByID(writer.writerID, '新增：' + $addPageForm.find('#topicTitle').val());
                            $(":input",$addPageForm).not(":button, :submit, :reset, :hidden").val("").removeAttr("checked").remove("selected");
                        } else {
                            showError('0x001添加失败,无法写入数据库');
                        }
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        ajaxFail(jqXHR, textStatus+'addBtn', errorThrown);
                        $addPageBtn.removeAttr('disabled');
                    });
                } else {
                    $addPageBtn.removeAttr('disabled');
                }
            });
        });
        function ajaxFail(jqXHR, textStatus, errorThrown) {
            showError('0x002添加失败，ajax失败' + textStatus);
        }
    </script>
</body>
</html>
